<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BetTrack Pro</title>
    <meta name="description" content="競馬収支管理・確定申告支援ツール">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- PWA Manifest (Android Icon含む) -->
    <link rel="manifest" type="application/manifest+json"
        href="data:application/manifest+json;base64,eyJuYW1lIjoiQmV0VHJhY2sgUHJvIiwic2hvcnRfbmFtZSI6IkJldFRyYWNrIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI2Y4ZmFmYyIsInRoZW1lX2NvbG9yIjoiIzEwYjk4MSIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWwsJTMzQ3N2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxODAgMTgwJyUzRSUzQ3JlY3Qgd2lkdGg9JzE4MCcgaGVpZ2h0PScxODAnIHJ4PSc0MCcgZmlsbD0nJTIzMTBiOTgxJy8lM0UlM0NwYXRoIGQ9J002MCA2MCBRNjAgMTMwIDkwIDEzMCBRMTIwIDEzMCAxMjAgNjAnIHN0cm9rZT0nd2hpdGUnIHN0cm9rZS13aWR0aD0nMTYnIGZpbGw9J25vbmUnIHN0cm9rZS1saW5lY2FwPSdyb3VuZCcvJTMlM0NpcmNsZSBjeD0nNjAnIGN5PSc2MCcgcj0nNicgZmlsbD0nd2hpdGUnLzMlM0NpcmNsZSBjeD0nMTIwJyBjeT0nNjAnIHI9JzYnIGZpbGw9J2h3aXRlJy8lM0UlM0Mvc3ZnJTM0Iiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwiLCJwdXJwb3NlIjoiYW55IG1hc2thYmxlIn1dfQ==">
    
    <!-- iOS Icons (蹄鉄デザイン) -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' rx='40' fill='%2310b981'/%3E%3Cpath d='M60 60 Q60 130 90 130 Q120 130 120 60' stroke='white' stroke-width='16' fill='none' stroke-linecap='round'/%3E%3Ccircle cx='60' cy='60' r='6' fill='white'/%3E%3Ccircle cx='120' cy='60' r='6' fill='white'/%3E%3C/svg%3E">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' rx='40' fill='%2310b981'/%3E%3Cpath d='M60 60 Q60 130 90 130 Q120 130 120 60' stroke='white' stroke-width='16' fill='none' stroke-linecap='round'/%3E%3Ccircle cx='60' cy='60' r='6' fill='white'/%3E%3Ccircle cx='120' cy='60' r='6' fill='white'/%3E%3C/svg%3E">

    <!-- Libraries (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

    <style>
        /* --- BASE STYLES --- */
        :root {
            --app-bg: #f8fafc;
            --card-bg: #ffffff;
            --primary: #059669;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", "Yu Gothic", sans-serif;
            background-color: var(--app-bg);
            color: #1e293b;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: env(safe-area-inset-bottom);
            overscroll-behavior-y: none;
            /* Pull-to-refresh無効化 */
        }

        /* Mobile Optimization */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Interactive Elements */
        .btn-press {
            transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-press:active {
            transform: scale(0.96);
        }

        .tile-btn {
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            touch-action: manipulation;
        }

        .tile-btn:active {
            transform: scale(0.96);
        }

        .input-focus-ring:focus-within {
            box-shadow: 0 0 0 2px #10b981;
            border-color: #10b981;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 260px;
            width: 100%;
        }

        /* Animations */
        .animate-slide-up {
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .animate-pop {
            animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes pop {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Ambient Backgrounds */
        .ambient-dawn { background: linear-gradient(135deg, #fef2f2 0%, #e0e7ff 100%); }
        .ambient-day { background: linear-gradient(135deg, #f0fdf4 0%, #dbeafe 100%); } /* 勝越し */
        .ambient-day-loss { background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); } /* 負越し */
        .ambient-dusk { background: linear-gradient(135deg, #fff7ed 0%, #ede9fe 100%); }
        .ambient-night { background: linear-gradient(135deg, #020617 0%, #1e1b4b 100%); }

        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }

        .dark .glass {
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .premium-card {
            background: linear-gradient(165deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.9) 100%);
            border: 1px solid rgba(255,255,255,0.8);
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05);
        }

        /* OCR Scan Line */
        .scan-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: #10b981;
            box-shadow: 0 0 15px #10b981;
            animation: scan 2s linear infinite;
            z-index: 10;
        }
        @keyframes scan { 0% { top: 0%; } 100% { top: 100%; } }

        /* --- PRINT OPTIMIZATION (A4 Full Spec) --- */
        @media print {
            @page {
                size: A4 landscape;
                margin: 10mm;
            }

            html,
            body {
                width: 100% !important;
                height: auto !important;
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
                color: black !important;
            }

            #root {
                display: block !important;
                width: 100% !important;
            }

            /* Hide UI */
            .app-view,
            .no-print,
            nav,
            .chart-wrapper,
            .input-area,
            .tile-btn,
            .chart-container,
            .toast-notification {
                display: none !important;
            }

            /* Show Print View */
            .print-view {
                display: block !important;
                visibility: visible !important;
                width: 100% !important;
                font-family: "Hiragino Mincho ProN", "Yu Mincho", serif;
            }

            /* Typography */
            .print-view h1 {
                font-size: 18pt;
                font-weight: bold;
                text-align: center;
                border-bottom: 2px solid black;
                margin-bottom: 5mm;
                padding-bottom: 2mm;
            }

            .print-view h2 {
                font-size: 12pt;
                font-weight: bold;
                margin-top: 5mm;
                margin-bottom: 2mm;
                border-left: 4px solid #333;
                padding-left: 2mm;
                background-color: #f0f0f0;
            }

            /* Table */
            .print-view table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 3mm;
                font-size: 9pt;
                table-layout: fixed;
            }

            .print-view th {
                background-color: #e0e0e0 !important;
                border: 1px solid black;
                padding: 4px;
                text-align: center;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .print-view td {
                border: 1px solid black;
                padding: 3px;
                vertical-align: middle;
            }

            .print-view .num {
                font-family: 'Courier New', monospace;
                text-align: right;
            }

            .print-view .center {
                text-align: center;
            }

            .page-break {
                page-break-before: always;
            }

            .disclaimer {
                font-size: 7pt;
                color: #444;
                border: 1px solid #ccc;
                padding: 5px;
                margin-top: 10px;
            }
        }

        .print-view {
            display: none;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- CONSTANTS & DATA ---
        const COURSE_DATA = {
            CENTRAL: {
                label: '中央競馬 (JRA)',
                tracks: ['東京', '中山', '京都', '阪神', '新潟', '福島', '中京', '小倉', '札幌', '函館']
            },
            LOCAL: {
                label: '地方競馬 (NAR)',
                tracks: ['大井', '船橋', '川崎', '浦和', '園田', '姫路', '高知', '名古屋', '笠松', '佐賀', '門別', '盛岡', '水沢', '金沢']
            },
            OVERSEAS: {
                label: '海外・その他',
                tracks: ['ロンシャン', 'シャティン', 'メイダン', 'アスコット', 'サンタアニタ', 'デルマー', '他海外']
            }
        };

        const SURFACES = [
            { id: 'TURF', label: '芝', color: 'bg-green-50 text-green-700 border-green-200' },
            { id: 'DIRT', label: 'ダート', color: 'bg-amber-50 text-amber-800 border-amber-200' },
            { id: 'OBSTACLE', label: '障害', color: 'bg-blue-50 text-blue-800 border-blue-200' }
        ];

        const DISTANCES = [
            { id: 'SPRINT', label: '短距離', sub: '〜1300m' },
            { id: 'MILE', label: 'マイル', sub: '1400〜1800m' },
            { id: 'INTERMEDIATE', label: '中距離', sub: '1900〜2300m' },
            { id: 'LONG', label: '長距離', sub: '2400m〜' }
        ];

        const CONDITIONS = ['良', '稍重', '重', '不良'];

        const GRADES = [
            { id: 'G1', label: 'G1', color: 'bg-yellow-50 text-yellow-700 border-yellow-200 ring-yellow-100' },
            { id: 'G2', label: 'G2', color: 'bg-rose-50 text-rose-700 border-rose-200 ring-rose-100' },
            { id: 'G3', label: 'G3', color: 'bg-emerald-50 text-emerald-700 border-emerald-200 ring-emerald-100' },
            { id: 'OP_L', label: 'OP/L', color: 'bg-indigo-50 text-indigo-700 border-indigo-100' },
            { id: '3C', label: '3勝C', color: 'bg-white text-slate-600 border-slate-100' },
            { id: '2C', label: '2勝C', color: 'bg-white text-slate-600 border-slate-100' },
            { id: '1C', label: '1勝C', color: 'bg-white text-slate-600 border-slate-100' },
            { id: 'COND', label: '条件', color: 'bg-white text-slate-600 border-slate-100' },
            { id: 'MAIDEN', label: '未勝利', color: 'bg-slate-50 text-slate-500 border-slate-100' },
            { id: 'NEW', label: '新馬', color: 'bg-sky-50 text-sky-700 border-sky-100' }
        ];

        const TICKET_TYPES = [
            { id: 'TAN', label: '単勝' },
            { id: 'FUKU', label: '複勝' },
            { id: 'WAKU', label: '枠連' },
            { id: 'UMA', label: '馬連' },
            { id: 'UTAN', label: '馬単' },
            { id: 'WIDE', label: 'ワイド' },
            { id: 'SANFUKU', label: '3連複' },
            { id: 'SANTAN', label: '3連単' },
            { id: 'WIN5', label: 'WIN5' }
        ];

        const TAG_OPTIONS = [
            { id: 'CONFIDENCE', label: '自信あり', icon: 'fire' },
            { id: 'VALUE', label: '穴狙い', icon: 'bolt' },
            { id: 'PADDOCK', label: 'パドック重視', icon: 'eye' },
            { id: 'DATA', label: 'データ重視', icon: 'chart-bar' }
        ];

        const TAX_BRACKETS = [
            { min: 0, max: 1949999, rate: 0.05, deduction: 0 },
            { min: 1950000, max: 3299999, rate: 0.10, deduction: 97500 },
            { min: 3300000, max: 6949999, rate: 0.20, deduction: 427500 },
            { min: 6950000, max: 8999999, rate: 0.23, deduction: 636000 },
            { min: 9000000, max: 17999999, rate: 0.33, deduction: 1536000 },
            { min: 18000000, max: 39999999, rate: 0.40, deduction: 2796000 },
            { min: 40000000, max: Infinity, rate: 0.45, deduction: 4796000 }
        ];

        // --- HELPERS ---
        const ProgressRing = ({ progress, size = 60, stroke = 5, color = "text-emerald-500" }) => {
            const radius = (size / 2) - (stroke * 2);
            const circumference = radius * 2 * Math.PI;
            const offset = circumference - (Math.min(100, progress) / 100) * circumference;
            return (
                <div className="relative inline-flex items-center justify-center">
                    <svg width={size} height={size} className="transform -rotate-90">
                        <circle className="text-slate-100 opacity-20" strokeWidth={stroke} stroke="currentColor" fill="transparent" r={radius} cx={size / 2} cy={size / 2} />
                        <circle className={`${color} transition-all duration-1000 ease-out`} strokeWidth={stroke} strokeDasharray={circumference} strokeDashoffset={offset} strokeLinecap="round" stroke="currentColor" fill="transparent" r={radius} cx={size / 2} cy={size / 2} />
                    </svg>
                    <span className="absolute text-[10px] font-black">{Math.round(progress)}%</span>
                </div>
            );
        };

        // --- COMPONENTS ---

        const Icon = ({ name, className = "" }) => <i className={`fas fa-${name} ${className}`}></i>;

        const Toast = ({ message, show }) => (
            <div className={`fixed top-6 left-1/2 transform -translate-x-1/2 z-[100] transition-all duration-300 ease-out pointer-events-none toast-notification ${show ? 'translate-y-0 opacity-100' : '-translate-y-8 opacity-0'}`}>
                <div className="bg-slate-800/90 backdrop-blur-md text-white px-6 py-3 rounded-full shadow-xl flex items-center gap-3">
                    <div className="bg-emerald-500 rounded-full w-5 h-5 flex items-center justify-center text-[10px]">
                        <Icon name="check" />
                    </div>
                    <span className="font-bold text-sm tracking-wide">{message}</span>
                </div>
            </div>
        );

        const Tile = ({ label, sub, active, onClick, className = "", colorClass = "" }) => (
            <button onClick={onClick} className={`tile-btn relative p-2 rounded-2xl border font-bold text-sm flex flex-col items-center justify-center min-h-[56px] w-full leading-snug shadow-sm overflow-hidden ${active ? `border-emerald-600 bg-emerald-600 text-white shadow-emerald-200 ring-2 ring-emerald-100 ring-offset-1` : `${colorClass || 'border-slate-100 bg-white text-slate-600'} hover:bg-slate-50 hover:border-emerald-200 ${className}`}`}>
                <span className="z-10 relative">{label}</span>
                {sub && <span className={`text-[9px] font-medium mt-0.5 z-10 relative ${active ? 'text-emerald-100' : 'text-slate-400'}`}>{sub}</span>}
                {active && <div className="absolute -top-4 -right-4 w-10 h-10 bg-white/20 rounded-full blur-sm" />}
            </button>
        );

        const SectionTitle = ({ children }) => (
            <h3 className="text-[11px] font-bold text-slate-400 uppercase tracking-widest mb-3 mt-7 ml-1 flex items-center">
                <span className="w-1 h-3 bg-emerald-500 mr-2 rounded-full"></span>{children}
            </h3>
        );

        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-2xl shadow-sm border border-slate-100 ${className}`}>
                {children}
            </div>
        );

        const OCRSimulator = ({ onComplete, onClose }) => {
            return (
                <div className="fixed inset-0 z-[200] bg-black/90 backdrop-blur-md flex flex-col items-center justify-center p-6 sm:p-10">
                    <div className="w-full max-w-sm aspect-[3/4] border-2 border-emerald-500/50 rounded-3xl relative overflow-hidden bg-slate-900 group">
                        <div className="scan-line" />
                        <div className="absolute inset-0 flex flex-col items-center justify-center text-emerald-500/30 gap-4">
                            <i className="fas fa-camera text-6xl animate-pulse" />
                            <p className="font-bold text-xs tracking-widest uppercase">Analyzing Ticket...</p>
                        </div>
                        <div className="absolute bottom-10 left-0 right-0 px-8">
                            <div className="h-1 w-full bg-white/10 rounded-full overflow-hidden">
                                <div className="h-full bg-emerald-500 animate-[progress_2s_ease-in-out_infinite]" style={{ width: '40%' }} />
                            </div>
                        </div>
                    </div>
                    <p className="text-white font-bold mt-8 mb-2">馬券/画面を読み取り中</p>
                    <p className="text-slate-400 text-[10px] text-center max-w-[240px]">PATの払戻画面や的中馬券をスキャン枠に合わせてください</p>
                    <div className="flex gap-4 mt-12 w-full max-w-sm">
                        <button onClick={onClose} className="flex-1 py-4 bg-white/10 text-white rounded-2xl font-bold">キャンセル</button>
                        <button onClick={onComplete} className="flex-1 py-4 bg-emerald-600 text-white rounded-2xl font-bold shadow-lg shadow-emerald-600/20">テスト解析実行</button>
                    </div>
                </div>
            );
        };

        // --- GLOBAL MEMORY ---
        let globalInputMemory = {
            date: new Date().toISOString().split('T')[0],
            courseCategory: 'CENTRAL',
            location: '',
            raceNumber: 11,
            surface: 'TURF',
            distance: 'MILE',
            condition: '良',
            grade: 'COND',
            ticketType: '3連単',
            horseNumber: null,
            investment: '',
            payout: '',
            memo: '',
            tags: []
        };

        // --- VIEWS ---

        const InputView = ({ onSave, recordCount }) => {
            const [step, setStep] = React.useState(0);
            const [data, setData] = React.useState(globalInputMemory);
            const [isScanning, setIsScanning] = React.useState(false);

            React.useEffect(() => {
                // 自動開催地推測 (曜日から大まかな場所を提案)
                const day = new Date().getDay();
                if (!data.location) {
                    if (day === 0 || day === 6) update('courseCategory', 'CENTRAL');
                    else update('courseCategory', 'LOCAL');
                }
            }, []);

            const update = (key, val) => {
                const newData = { ...data, [key]: val };
                if (key === 'courseCategory') newData.location = '';
                setData(newData);
                globalInputMemory = { ...globalInputMemory, ...newData };
            };

            const StepIndicator = () => (
                <div className="flex gap-2 mb-8 justify-center items-center">
                    {[0, 1, 2, 3, 4].map(s => (
                        <div key={s} className={`h-1.5 rounded-full transition-all duration-500 ease-out ${step >= s ? 'w-8 bg-emerald-500' : 'w-3 bg-slate-200'}`} />
                    ))}
                </div>
            );

            return (
                <div className="pb-32 bg-transparent min-h-screen input-area">
                    <div className="glass sticky top-0 z-20 px-5 py-4 flex items-center justify-between border-b">
                        <h2 className="font-bold text-slate-800 text-lg tracking-tight">
                            <span className="text-emerald-600 mr-2 font-black">STEP {step + 1}</span>
                            <span className="text-sm font-medium text-slate-400">
                                {step === 0 && '開催情報'} {step === 1 && 'レース詳細'} {step === 2 && '軸馬選択'} {step === 3 && 'メモ・タグ'} {step === 4 && '収支入力'}
                            </span>
                        </h2>
                        <div className="flex gap-2">
                            <button onClick={() => setIsScanning(true)} className="p-2.5 bg-white rounded-xl text-emerald-600 shadow-sm border border-slate-100"><i className="fas fa-camera" /></button>
                            {step > 0 && <button onClick={() => setStep(step - 1)} className="btn-press text-xs font-bold text-slate-500 bg-white px-4 py-2 rounded-xl shadow-sm border">戻る</button>}
                        </div>
                    </div>

                    <div className="p-5 max-w-lg mx-auto animate-slide-up">
                        <StepIndicator />
                        {/* 既存のステップコンテンツ... */}
                        {step === 0 && (
                            <>
                                <SectionTitle>日付</SectionTitle>
                                <input type="date" value={data.date} onChange={e => update('date', e.target.value)} className="w-full p-4 glass rounded-2xl border font-bold text-lg mb-6 shadow-sm focus:border-emerald-500 outline-none" />
                                <SectionTitle>主催カテゴリ</SectionTitle>
                                <div className="flex p-1.5 glass rounded-2xl mb-6">
                                    {Object.keys(COURSE_DATA).map(cat => (
                                        <button key={cat} onClick={() => update('courseCategory', cat)} className={`flex-1 py-3 rounded-xl font-bold text-xs transition-all ${data.courseCategory === cat ? 'bg-emerald-600 text-white shadow-lg' : 'text-slate-500'}`}>{COURSE_DATA[cat].label.split('(')[0]}</button>
                                    ))}
                                </div>
                                <SectionTitle>競馬場</SectionTitle>
                                <div className="grid grid-cols-4 gap-2.5 mb-8">
                                    {COURSE_DATA[data.courseCategory].tracks.map(track => <Tile key={track} label={track} active={data.location === track} onClick={() => update('location', track)} />)}
                                </div>
                                <button onClick={() => setStep(1)} disabled={!data.location} className="btn-press w-full py-4 bg-emerald-600 text-white rounded-2xl font-bold shadow-xl shadow-emerald-500/20 transition-all text-lg">次へ進む</button>
                            </>
                        )}
                        {/* step 1~4 は同様に glass / premium 調整 */}
                        {step === 1 && (
                            <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
                                <SectionTitle>レース詳細</SectionTitle>
                                <div className="grid grid-cols-6 gap-2 mb-4">
                                    {[...Array(12)].map((_, i) => <Tile key={i} label={`${i+1}R`} active={data.raceNumber === i+1} onClick={() => update('raceNumber', i+1)} />)}
                                </div>

                                <div className="grid grid-cols-3 gap-2 mb-4">
                                     {SURFACES.map(s => <Tile key={s.id} label={s.label} active={data.surface === s.id} onClick={() => update('surface', s.id)} colorClass={s.color} />)}
                                </div>
         
                                 <div className="grid grid-cols-4 gap-2 mb-4">
                                     {DISTANCES.map(d => <Tile key={d.id} label={d.label} sub={d.sub} active={data.distance === d.id} onClick={() => update('distance', d.id)} />)}
                                 </div>
         
                                 <div className="grid grid-cols-4 gap-2 mb-4">
                                     {CONDITIONS.map(c => <Tile key={c} label={c} active={data.condition === c} onClick={() => update('condition', c)} />)}
                                 </div>
         
                                <SectionTitle>クラス・グレード</SectionTitle>
                                 <div className="grid grid-cols-5 gap-2 mb-6">
                                      {GRADES.map(g => <Tile key={g.id} label={g.label} active={data.grade === g.id} onClick={() => update('grade', g.id)}  colorClass={g.color} />)}
                                 </div>

                                <SectionTitle>券種</SectionTitle>
                                <div className="grid grid-cols-3 gap-2.5 mb-8">
                                    {TICKET_TYPES.map(t => <Tile key={t.id} label={t.label} active={data.ticketType === t.label} onClick={() => update('ticketType', t.label)} />)}
                                </div>
                                <button onClick={() => setStep(2)} className="btn-press w-full py-4 bg-emerald-600 text-white rounded-2xl font-bold shadow-xl shadow-emerald-500/20 text-lg">次へ進む</button>
                            </div>
                        )}
                        {step === 2 && (
                            <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
                                <SectionTitle>軸馬選択</SectionTitle>
                                <div className="grid grid-cols-6 gap-2 mb-8">
                                    {[...Array(18)].map((_, i) => <Tile key={i} label={i + 1} active={data.horseNumber === i + 1} onClick={() => update('horseNumber', i + 1)} />)}
                                </div>
                                <button onClick={() => setStep(3)} className="btn-press w-full py-4 bg-emerald-600 text-white rounded-2xl font-bold shadow-xl shadow-emerald-500/20 text-lg">次へ進む</button>
                            </div>
                        )}
                        {step === 3 && (
                            <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
                                <SectionTitle>メモ</SectionTitle>
                                <textarea value={data.memo} onChange={e => update('memo', e.target.value)} placeholder="レースの感想や特記事項..." className="w-full p-4 glass rounded-2xl border min-h-[120px] font-medium text-slate-600 focus:border-emerald-500 outline-none mb-6" />
                                
                                <SectionTitle>タグ</SectionTitle>
                                <div className="flex flex-wrap gap-2 mb-8">
                                    {TAG_OPTIONS.map(t => (
                                        <button key={t.id} onClick={() => {
                                            const newTags = data.tags.includes(t.id) ? data.tags.filter(id => id !== t.id) : [...data.tags, t.id];
                                            update('tags', newTags);
                                        }} className={`px-4 py-2 rounded-xl text-xs font-bold border transition-all ${data.tags.includes(t.id) ? 'bg-emerald-600 border-emerald-600 text-white' : 'bg-white border-slate-200 text-slate-500'}`}>
                                            <Icon name={t.icon} className="mr-2" />{t.label}
                                        </button>
                                    ))}
                                </div>
                                <button onClick={() => setStep(4)} className="btn-press w-full py-4 bg-emerald-600 text-white rounded-2xl font-bold shadow-xl shadow-emerald-500/20 text-lg">次へ進む</button>
                            </div>
                        )}
                        {step === 4 && (
                            <div className="space-y-6">
                                <div className="glass p-6 rounded-3xl">
                                    <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Investment</p>
                                    <input type="number" value={data.investment} onChange={e => update('investment', e.target.value)} placeholder="投資額を入力" className="w-full text-4xl font-black bg-transparent border-b-2 border-emerald-500 pb-2 outline-none" />
                                </div>
                                <div className="glass p-6 rounded-3xl">
                                    <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Payout</p>
                                    <input type="number" value={data.payout} onChange={e => update('payout', e.target.value)} placeholder="回収額を入力" className="w-full text-4xl font-black bg-transparent border-b-2 border-emerald-500 pb-2 outline-none" />
                                </div>
                                <button onClick={() => { onSave(data); setStep(0); }} className="btn-press w-full py-5 bg-emerald-600 text-white rounded-2xl font-bold shadow-xl shadow-emerald-500/20 text-xl mt-4">記録を保存する</button>
                            </div>
                        )}
                    </div>

                    {isScanning && <OCRSimulator onComplete={() => { setIsScanning(false); update('payout', '58400'); update('investment', '6000'); setStep(4); }} onClose={() => setIsScanning(false)} />}
                </div>
            );
        };

        const AnalysisView = ({ records, goals }) => {
            const [selectedYear, setSelectedYear] = React.useState(new Date().getFullYear());
            const yearRecords = React.useMemo(() => records.filter(r => new Date(r.date).getFullYear() === selectedYear), [records, selectedYear]);

            // Stats Logic
            const totalRevenue = yearRecords.reduce((sum, r) => sum + (parseInt(r.payout) || 0), 0);
            const totalInvestment = yearRecords.reduce((sum, r) => sum + (parseInt(r.investment) || 0), 0);
            const netProfit = totalRevenue - totalInvestment;
            const recoveryRate = totalInvestment > 0 ? (totalRevenue / totalInvestment) * 100 : 0;

            // 相性分析 (Best Combinations)
            const aisyos = React.useMemo(() => {
                const patterns = {};
                yearRecords.forEach(r => {
                    const key = `${r.location} × ${r.ticketType}`;
                    if (!patterns[key]) patterns[key] = { inv: 0, pay: 0, count: 0 };
                    patterns[key].inv += parseInt(r.investment);
                    patterns[key].pay += parseInt(r.payout);
                    patterns[key].count += 1;
                });
                return Object.entries(patterns)
                    .map(([k, v]) => ({ name: k, recovery: (v.pay / v.inv) * 100, profit: v.pay - v.inv, count: v.count }))
                    .filter(p => p.count >= 2)
                    .sort((a, b) => b.recovery - a.recovery);
            }, [yearRecords]);

            const chartAssetRef = React.useRef(null);
            const chartRefs = React.useRef([]);

            React.useEffect(() => {
                chartRefs.current.forEach(c => c.destroy());
                chartRefs.current = [];
                if (!chartAssetRef.current) return;

                const sorted = [...yearRecords].sort((a, b) => new Date(a.date) - new Date(b.date));
                let cum = 0;
                const labels = sorted.map(r => r.date.substring(5));
                const data = sorted.map(r => { cum += (r.payout - r.investment); return cum; });

                chartRefs.current.push(new Chart(chartAssetRef.current, {
                    type: 'line',
                    data: { labels, datasets: [{ label: '累計収支', data, borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)', fill: true, tension: 0.3, pointRadius: 2 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                }));
            }, [yearRecords]);

            return (
                <div className="pb-40 p-5 min-h-screen">
                    <header className="flex justify-between items-center mb-8">
                        <div>
                            <h2 className="text-3xl font-black text-slate-800 tracking-tighter">分析インサイト</h2>
                            <p className="text-xs font-bold text-slate-400 mt-1 uppercase tracking-widest">Advanced Betting Data</p>
                        </div>
                        <select value={selectedYear} onChange={e => setSelectedYear(parseInt(e.target.value))} className="glass px-4 py-2 rounded-xl font-bold text-sm outline-none border-none">
                            {[2024, 2025, 2026].map(y => <option key={y} value={y}>{y}年度</option>)}
                        </select>
                    </header>

                    {/* Progress Goals */}
                    <div className="grid grid-cols-2 gap-4 mb-8">
                        <div className="glass p-5 rounded-[2.5rem] flex flex-col items-center">
                            <ProgressRing progress={(totalRevenue / goals.revenue) * 100} size={80} stroke={8} />
                            <p className="text-[10px] font-black text-slate-400 mt-4 uppercase">収益目標</p>
                            <p className="text-lg font-black text-slate-800 tracking-tight">{totalRevenue.toLocaleString()}</p>
                        </div>
                        <div className="glass p-5 rounded-[2.5rem] flex flex-col items-center">
                            <ProgressRing progress={(recoveryRate / goals.recovery) * 100} size={80} stroke={8} color="text-amber-500" />
                            <p className="text-[10px] font-black text-slate-400 mt-4 uppercase">回収率目標</p>
                            <p className="text-lg font-black text-slate-800 tracking-tight">{Math.round(recoveryRate)}%</p>
                        </div>
                    </div>

                    <Card className={`p-6 rounded-[2.5rem] mb-8 text-white relative overflow-hidden ${netProfit >= 0 ? 'bg-emerald-600' : 'bg-rose-500'} shadow-2xl`}>
                        <div className="relative z-10">
                            <p className="text-white/60 text-[10px] font-black uppercase tracking-widest mb-1">Current Balanced Balance</p>
                            <h3 className="text-4xl font-black tracking-tighter">{netProfit.toLocaleString()}<span className="text-sm font-normal ml-2">円</span></h3>
                            <div className="mt-6 flex gap-4">
                                <div className="bg-white/10 px-4 py-2 rounded-2xl backdrop-blur-md">
                                    <p className="text-[9px] font-bold opacity-60">回収率</p>
                                    <p className="text-lg font-black">{Math.round(recoveryRate)}%</p>
                                </div>
                                <div className="bg-white/10 px-4 py-2 rounded-2xl backdrop-blur-md">
                                    <p className="text-[9px] font-bold opacity-60">レース数</p>
                                    <p className="text-lg font-black">{yearRecords.length}</p>
                                </div>
                            </div>
                        </div>
                        <i className={`fas ${netProfit >= 0 ? 'fa-chart-line' : 'fa-chart-bar'} absolute -bottom-10 -right-10 text-[12rem] opacity-10`} />
                    </Card>

                    <SectionTitle>最強の勝負パターン (相性診断)</SectionTitle>
                    <div className="space-y-4 mb-8">
                        {aisyos.slice(0, 3).map((a, i) => (
                            <div key={i} className="glass p-5 rounded-3xl flex items-center justify-between border-l-4 border-l-amber-400">
                                <div className="flex items-center gap-4">
                                    <div className="w-10 h-10 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center font-black">#{i+1}</div>
                                    <div>
                                        <p className="text-sm font-black text-slate-800">{a.name}</p>
                                        <p className="text-[10px] text-slate-400 font-bold">サンプル数: {a.count}レース</p>
                                    </div>
                                </div>
                                <div className="text-right">
                                    <p className="text-xl font-black text-emerald-600">{Math.round(a.recovery)}%</p>
                                    <p className="text-[10px] text-emerald-500 font-bold">利益: +{a.profit.toLocaleString()}</p>
                                </div>
                            </div>
                        ))}
                    </div>

                    <Card className="p-6 rounded-[2.5rem] mb-8">
                        <h3 className="font-bold text-slate-700 mb-6 text-sm">累計収支推移</h3>
                        <div className="h-[240px] w-full"><canvas ref={chartAssetRef}></canvas></div>
                    </Card>

                    <button onClick={() => window.print()} className="btn-press w-full py-5 glass rounded-[2rem] font-black text-slate-800 flex items-center justify-center gap-3 shadow-lg">
                        <i className="fas fa-print" /> プロフェッショナル帳票出力
                    </button>
                </div>
            );
        };


        const ListView = ({ records, onDelete }) => {
            const [filter, setFilter] = React.useState({ track: '', type: '', text: '' });
            const [showFilter, setShowFilter] = React.useState(false);

            const filtered = React.useMemo(() => {
                return records.filter(r => {
                    const matchTrack = !filter.track || r.location === filter.track;
                    const matchType = !filter.type || r.ticketType === filter.type;
                    const matchSearch = !filter.text ||
                        r.location.includes(filter.text) ||
                        (r.memo && r.memo.includes(filter.text));
                    return matchTrack && matchType && matchSearch;
                }).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            }, [records, filter]);

            const tracks = Array.from(new Set(records.map(r => r.location)));

            return (
                <div className="pb-32 p-5 bg-slate-50 min-h-screen">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-slate-800 flex items-center"><Icon name="list" className="mr-3 text-emerald-600" />履歴一覧</h2>
                        <button onClick={() => setShowFilter(!showFilter)} className={`p-2 rounded-xl border transition-all ${showFilter ? 'bg-emerald-600 border-emerald-600 text-white' : 'bg-white border-slate-200 text-slate-500'}`}>
                            <Icon name="filter" />
                        </button>
                    </div>

                    {showFilter && (
                        <Card className="p-4 mb-6 space-y-3 animate-fade-in">
                            <div className="flex gap-2">
                                <select value={filter.track} onChange={e => setFilter({ ...filter, track: e.target.value })} className="flex-1 p-2 bg-slate-50 border border-slate-200 rounded-lg text-xs font-bold text-slate-600 outline-none">
                                    <option value="">全ての場所</option>
                                    {tracks.map(t => <option key={t} value={t}>{t}</option>)}
                                </select>
                                <select value={filter.type} onChange={e => setFilter({ ...filter, type: e.target.value })} className="flex-1 p-2 bg-slate-50 border border-slate-200 rounded-lg text-xs font-bold text-slate-600 outline-none">
                                    <option value="">全ての券種</option>
                                    {TICKET_TYPES.map(t => <option key={t.id} value={t.label}>{t.label}</option>)}
                                </select>
                            </div>
                            <div className="relative">
                                <input
                                    type="text"
                                    placeholder="メモや場所で検索..."
                                    value={filter.text}
                                    onChange={e => setFilter({ ...filter, text: e.target.value })}
                                    className="w-full p-2.5 pl-9 bg-slate-50 border border-slate-200 rounded-lg text-xs font-medium outline-none focus:border-emerald-500"
                                />
                                <Icon name="search" className="absolute left-3 top-3 text-slate-400" />
                            </div>
                        </Card>
                    )}

                    {filtered.length === 0 ? <div className="text-center py-32 text-slate-400 font-bold text-sm">記録が見つかりません</div> :
                        <div className="space-y-4">{filtered.map(r => {
                            const profit = (parseInt(r.payout) || 0) - (parseInt(r.investment) || 0);
                            const isWin = (parseInt(r.payout) || 0) > 0;

                            const cardStyle = isWin
                                ? 'bg-emerald-50/40 border-emerald-200 border-l-4 border-l-emerald-500'
                                : 'bg-white border-slate-100 border-l-4 border-l-slate-200';

                            return (
                                <div key={r.id} className={`rounded-2xl p-5 shadow-sm border relative overflow-hidden transition-all ${cardStyle}`}>
                                    {isWin && (
                                        <div className="absolute top-0 right-0 bg-emerald-100 text-emerald-600 px-3 py-1 rounded-bl-xl text-[10px] font-black tracking-wider flex items-center gap-1">
                                            <Icon name="crown" /> WIN
                                        </div>
                                    )}
                                    <div className="flex justify-between items-start mb-3">
                                        <div>
                                            <div className="flex items-center gap-2 mb-1.5">
                                                <span className="text-[10px] font-bold text-slate-400 tracking-wider">
                                                    {r.date.replace(/-/g, '.')}
                                                    {r.tags && r.tags.length > 0 && <span className="ml-2 text-emerald-500"><Icon name="tag" /></span>}
                                                </span>
                                            </div>
                                            <div className="font-black text-lg text-slate-800 flex items-baseline gap-2">
                                                {r.location} <span className="text-sm font-bold text-slate-500 bg-slate-100/50 px-2 py-0.5 rounded-md">{r.raceNumber}R</span>
                                            </div>
                                        </div>
                                        <div className="text-right mt-4">
                                            <div className={`font-black text-xl tracking-tight ${profit > 0 ? 'text-emerald-600' : profit < 0 ? 'text-rose-500' : 'text-slate-400'}`}>
                                                {profit > 0 ? '+' : ''}{profit.toLocaleString()}
                                            </div>
                                        </div>
                                    </div>

                                    <div className="flex flex-wrap gap-2 mb-3 text-[9px] font-bold">
                                        <span className="px-2 py-0.5 bg-white text-slate-500 rounded border border-slate-200">{GRADES.find(g => g.id === r.grade)?.label}</span>
                                        <span className="px-2 py-0.5 bg-white text-slate-500 rounded border border-slate-200">{r.ticketType}</span>
                                        {r.horseNumber && <span className="px-2 py-0.5 bg-indigo-50 text-indigo-600 rounded border border-indigo-100">#{r.horseNumber}</span>}
                                        {r.tags && r.tags.map(tid => {
                                            const tag = TAG_OPTIONS.find(t => t.id === tid);
                                            return tag ? <span key={tid} className="px-2 py-0.5 bg-amber-50 text-amber-600 rounded border border-amber-100"><Icon name={tag.icon} className="mr-1" />{tag.label}</span> : null;
                                        })}
                                    </div>

                                    {r.memo && (
                                        <div className="mb-4 p-3 bg-slate-50/80 rounded-xl text-[11px] text-slate-600 font-medium leading-relaxed border border-slate-100">
                                            {r.memo}
                                        </div>
                                    )}

                                    <div className="flex items-center justify-between border-t border-slate-100/50 pt-3 mt-2">
                                        <div className="text-[10px] text-slate-400 font-medium">
                                            投: {parseInt(r.investment).toLocaleString()} / 回: {parseInt(r.payout).toLocaleString()}
                                        </div>
                                        <button onClick={() => onDelete(r.id)} className="text-rose-400 text-xs font-bold hover:text-rose-600 px-2 py-1 transition-colors"><Icon name="trash-alt" /> 削除</button>
                                    </div>
                                </div>
                            );
                        })}</div>
                    }
                </div>
            );
        };

        const SettingsView = ({ records, onImport }) => {
            const exportData = () => {
                const blob = new Blob([JSON.stringify(records, null, 2)], { type: "application/json" });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `bettrack_backup_${new Date().toISOString().slice(0, 10)}.json`;
                link.click();
            };
            return (
                <div className="pb-32 p-5 bg-slate-50 min-h-screen">
                    <h2 className="text-2xl font-bold text-slate-800 mb-6 flex items-center"><Icon name="cog" className="mr-3 text-emerald-600" />設定</h2>
                    <div className="space-y-4">
                        <Card className="p-6">
                            <div className="flex items-center mb-5"><div className="p-3 bg-emerald-50 text-emerald-600 rounded-full mr-4"><Icon name="download" /></div><div><h3 className="font-bold text-slate-700">バックアップ作成</h3><p className="text-[10px] text-slate-400">全データをJSONファイルとして保存します</p></div></div>
                            <button onClick={exportData} className="btn-press w-full py-4 bg-emerald-600 text-white rounded-2xl font-bold shadow-md shadow-emerald-600/20 hover:bg-emerald-700 transition-all">データをダウンロード</button>
                        </Card>

                        <Card className="p-6">
                            <div className="flex items-center mb-5"><div className="p-3 bg-blue-50 text-blue-600 rounded-full mr-4"><Icon name="upload" /></div><div><h3 className="font-bold text-slate-700">データ復元</h3><p className="text-[10px] text-slate-400">バックアップファイルを読み込みます</p></div></div>
                            <label className="btn-press block w-full py-4 bg-slate-50 text-slate-600 rounded-2xl font-bold text-center cursor-pointer border-2 border-dashed border-slate-200 hover:bg-slate-100 hover:border-slate-300 transition-all">
                                JSONファイルを選択<input type="file" onChange={onImport} accept=".json" className="hidden" />
                            </label>
                        </Card>
                    </div>
                </div>
            );
        };

        // --- PRINT VIEW COMPONENT (A4 Optimized) ---
        const PrintView = ({ records }) => {
            const currentYear = new Date().getFullYear();
            const yearRecords = records.filter(r => new Date(r.date).getFullYear() === currentYear);

            const totalRevenue = yearRecords.reduce((sum, r) => sum + (parseInt(r.payout) || 0), 0);
            const winningRecords = yearRecords.filter(r => (parseInt(r.payout) || 0) > 0);
            const deductibleCost = winningRecords.reduce((sum, r) => sum + (parseInt(r.investment) || 0), 0);
            const temporaryIncome = Math.max(0, totalRevenue - deductibleCost - 500000);
            const taxableIncome = Math.floor(temporaryIncome * 0.5);

            let incomeTax = 0;
            if (taxableIncome > 0) {
                const bracket = TAX_BRACKETS.find(b => taxableIncome >= b.min && taxableIncome <= b.max);
                if (bracket) incomeTax = (taxableIncome * bracket.rate) - bracket.deduction;
            }
            incomeTax = Math.max(0, Math.floor(incomeTax));
            const reconstructionTax = Math.floor(incomeTax * 0.021);
            const estimatedTaxTotal = incomeTax + reconstructionTax;

            const sortedRecords = [...winningRecords].sort((a, b) => new Date(a.date) - new Date(b.date));

            return (
                <div className="print-view">
                    <h1>{currentYear}年 競馬収支・一時所得計算書</h1>
                    <div className="disclaimer">
                        <strong>【重要】</strong> 本書類はアプリ内の記録に基づく計算結果です。確定申告の際は、必ず源泉徴収票や支払調書と照合し、所轄税務署の指導に従ってください。
                    </div>

                    <h2>1. 収支計算概要</h2>
                    <table>
                        <thead><tr><th style={{ width: '30%' }}>項目</th><th style={{ width: '40%' }}>計算式・内容</th><th style={{ width: '30%' }}>金額</th></tr></thead>
                        <tbody>
                            <tr><td>総払戻金額 (A)</td><td>的中投票券の払戻金合計</td><td className="num">{totalRevenue.toLocaleString()} 円</td></tr>
                            <tr><td>必要経費 (B)</td><td>的中投票券の購入費用</td><td className="num">▲ {deductibleCost.toLocaleString()} 円</td></tr>
                            <tr><td>特別控除額 (C)</td><td>一時所得の特別控除 (最大50万円)</td><td className="num">▲ 500,000 円</td></tr>
                            <tr style={{ backgroundColor: '#eee' }}><td>一時所得 (D)</td><td>A - B - C (赤字は0)</td><td className="num font-bold">{temporaryIncome.toLocaleString()} 円</td></tr>
                        </tbody>
                    </table>

                    <h2>2. 納税額シミュレーション (目安)</h2>
                    <table>
                        <thead><tr><th style={{ width: '30%' }}>項目</th><th style={{ width: '40%' }}>計算式</th><th style={{ width: '30%' }}>金額</th></tr></thead>
                        <tbody>
                            <tr><td>課税対象額 (E)</td><td>一時所得 (D) × 1/2</td><td className="num">{taxableIncome.toLocaleString()} 円</td></tr>
                            <tr><td>算出所得税 (F)</td><td>(E) × 税率 - 控除額</td><td className="num">{incomeTax.toLocaleString()} 円</td></tr>
                            <tr><td>復興特別所得税 (G)</td><td>(F) × 2.1%</td><td className="num">{reconstructionTax.toLocaleString()} 円</td></tr>
                            <tr style={{ backgroundColor: '#eee' }}><td>最終納税目安</td><td>(F) + (G)</td><td className="num font-bold">{estimatedTaxTotal.toLocaleString()} 円</td></tr>
                        </tbody>
                    </table>

                    <div className="page-break"></div>

                    <h2>3. 的中履歴明細書 (抜粋)</h2>
                    <table>
                        <thead>
                            <tr>
                                <th style={{ width: '12%' }}>日付</th>
                                <th style={{ width: '12%' }}>場所</th>
                                <th style={{ width: '6%' }}>R</th>
                                <th style={{ width: '10%' }}>券種</th>
                                <th style={{ width: '20%' }}>投資 (経費)</th>
                                <th style={{ width: '20%' }}>払戻 (収入)</th>
                                <th style={{ width: '20%' }}>差引収支</th>
                            </tr>
                        </thead>
                        <tbody>
                            {sortedRecords.map((r, i) => (
                                <tr key={i}>
                                    <td className="center">{r.date}</td>
                                    <td className="center">{r.location}</td>
                                    <td className="center">{r.raceNumber}</td>
                                    <td className="center">{r.ticketType}</td>
                                    <td className="num">{parseInt(r.investment).toLocaleString()}</td>
                                    <td className="num font-bold">{parseInt(r.payout).toLocaleString()}</td>
                                    <td className="num">+{(parseInt(r.payout) - parseInt(r.investment)).toLocaleString()}</td>
                                </tr>
                            ))}
                            <tr style={{ backgroundColor: '#eee', fontWeight: 'bold', borderTop: '2px solid black' }}>
                                <td colSpan="4" className="center">合計</td>
                                <td className="num">{deductibleCost.toLocaleString()}</td>
                                <td className="num">{totalRevenue.toLocaleString()}</td>
                                <td className="num">+{(totalRevenue - deductibleCost).toLocaleString()}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [view, setView] = React.useState('INPUT');
            const [records, setRecords] = React.useState([]);
            const [toast, setToast] = React.useState({ show: false, message: '' });
            const [goals, setGoals] = React.useState({ revenue: 1000000, recovery: 110 });

            React.useEffect(() => {
                const saved = localStorage.getItem('bettrack_records_v1');
                if (saved) try { setRecords(JSON.parse(saved)); } catch (e) { }
            }, []);

            const currentBalance = React.useMemo(() => {
                const total = records.reduce((sum, r) => sum + (r.payout - r.investment), 0);
                return total;
            }, [records]);

            const ambientClass = React.useMemo(() => {
                const hour = new Date().getHours();
                if (hour >= 5 && hour < 10) return 'ambient-dawn';
                if (hour >= 10 && hour < 16) return currentBalance >= 0 ? 'ambient-day' : 'ambient-day-loss';
                if (hour >= 16 && hour < 19) return 'ambient-dusk';
                return 'ambient-night';
            }, [currentBalance]);

            const saveRecord = (data) => {
                if (data.payout > 0) confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#10b981', '#059669', '#fcd34d'] });
                const newRecord = { ...data, id: Date.now().toString(), investment: parseInt(data.investment), payout: parseInt(data.payout) };
                const updated = [newRecord, ...records];
                setRecords(updated);
                localStorage.setItem('bettrack_records_v1', JSON.stringify(updated));
                setToast({ show: true, message: '記録を保存しました' });
                setTimeout(() => setToast({ show: false, message: '' }), 3000);
            };

            return (
                <div className={`min-h-screen transition-all duration-1000 ${ambientClass}`}>
                    <Toast message={toast.message} show={toast.show} />
                    <div className="max-w-md mx-auto relative min-h-screen">
                        <main className="h-full">
                            {view === 'INPUT' && <InputView onSave={saveRecord} recordCount={records.length} />}
                            {view === 'LIST' && <ListView records={records} onDelete={(id) => setRecords(records.filter(r => r.id !== id))} />}
                            {view === 'ANALYSIS' && <AnalysisView records={records} goals={goals} />}
                            {view === 'SETTINGS' && <SettingsView records={records} onImport={(e) => {}} />}
                        </main>
                        <nav className="fixed bottom-0 left-0 right-0 max-w-md mx-auto glass border-t flex justify-around items-center h-[85px] z-50">
                            {[{ id: 'INPUT', icon: 'plus-circle', label: '記録' }, { id: 'LIST', icon: 'list', label: '履歴' }, { id: 'ANALYSIS', icon: 'chart-pie', label: '分析' }, { id: 'SETTINGS', icon: 'cog', label: '設定' }].map(item => (
                                <button key={item.id} onClick={() => setView(item.id)} className={`flex flex-col items-center justify-center w-full h-full transition-all ${view === item.id ? 'text-emerald-600 scale-105' : 'text-slate-400'}`}>
                                    <i className={`fas fa-${item.icon} text-xl mb-1`} />
                                    <span className="text-[10px] font-bold">{item.label}</span>
                                </button>
                            ))}
                        </nav>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>